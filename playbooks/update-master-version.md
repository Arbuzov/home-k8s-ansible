# Update Master Version Playbook

## –û–ø–∏—Å–∞–Ω–∏–µ
–ü–ª–µ–π–±—É–∫ `update-master-version.yml` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è master –Ω–æ–¥—ã Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞.

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- ‚úÖ **–ü–æ—ç—Ç–∞–ø–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: kubeadm ‚Üí control-plane ‚Üí kubelet/kubectl
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ control-plane –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤**: etcd, kube-apiserver, kube-controller-manager, kube-scheduler
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è** API —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- ‚úÖ **–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞** held packages
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞** –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –û—Å–Ω–æ–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
```bash
# –û–±–Ω–æ–≤–∏—Ç—å master –¥–æ –≤–µ—Ä—Å–∏–∏ –∏–∑ inventory.yml
ansible-playbook playbooks/update-master-version.yml \
  -e target_node=kube-master \
  -e @credentials.json
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
```bash
# Dry-run –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
ansible-playbook playbooks/update-master-version.yml \
  -e target_node=kube-master \
  -e @credentials.json \
  --check --diff
```

## –ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

1. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞**: –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —ç—Ç–æ master –Ω–æ–¥–∞
2. **Unhold**: –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ Kubernetes –ø–∞–∫–µ—Ç–æ–≤
3. **kubeadm Update**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ kubeadm –¥–æ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
4. **Upgrade Plan**: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
5. **Control Plane**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ control-plane:
   - etcd
   - kube-apiserver
   - kube-controller-manager
   - kube-scheduler
6. **kubelet/kubectl**: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ kubelet –∏ kubectl
7. **Hold**: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –Ω–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
8. **Restart**: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ kubelet
9. **Health Check**: –ü—Ä–æ–≤–µ—Ä–∫–∞ API —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
10. **Verify**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è

### Control Plane:
- **etcd**: –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞
- **kube-apiserver**: API —Å–µ—Ä–≤–µ—Ä Kubernetes
- **kube-controller-manager**: –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∫–ª–∞—Å—Ç–µ—Ä–∞
- **kube-scheduler**: –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–æ–¥–æ–≤

### Node Components:
- **kubelet**: –ê–≥–µ–Ω—Ç –Ω–∞ –Ω–æ–¥–µ
- **kubectl**: CLI –∫–ª–∏–µ–Ω—Ç
- **kubeadm**: –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–º

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

- `target_node`: –ò–º—è master –Ω–æ–¥—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: kube-master)
- `kubernetes_version`: –ë–µ—Ä–µ—Ç—Å—è –∏–∑ inventory.yml
- `kubernetes_major_minor`: –ë–µ—Ä–µ—Ç—Å—è –∏–∑ inventory.yml
- `node_role`: –î–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 'master'

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- –î–æ—Å—Ç—É–ø –∫ master –Ω–æ–¥–µ —Å –ø—Ä–∞–≤–∞–º–∏ sudo
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π inventory.yml —Å –≤–µ—Ä—Å–∏—è–º–∏ K8s
- –°—Ç–∞–±–∏–ª—å–Ω–æ–µ —Å–µ—Ç–µ–≤–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)

## –ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
TASK [Display final master node status] *****************************************************
ok: [kube-master] => {
    "msg": [
        "NAME          STATUS   ROLES                  AGE     VERSION   ...",
        "kube-master   Ready    control-plane,worker   2y35d   v1.33.4   ..."
    ]
}

TASK [Display component status] *************************************************************
ok: [kube-master] => {
    "msg": [
        "NAME                 STATUS    MESSAGE   ERROR",
        "scheduler            Healthy   ok        ",
        "controller-manager   Healthy   ok        ",
        "etcd-0               Healthy   ok        "
    ]
}
```

## –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

‚ö†Ô∏è **–ü–æ—Ä—è–¥–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ master –Ω–æ–¥—É –ü–û–°–õ–ï–î–ù–ï–ô, –ø–æ—Å–ª–µ –≤—Å–µ—Ö worker –Ω–æ–¥

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ü–ª–µ–π–±—É–∫ —Å–æ–∑–¥–∞–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –≤—Å–µ—Ö –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ –≤ `/etc/kubernetes/tmp/`

üîÑ **–û—Ç–∫–∞—Ç**: –í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º –º–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –∏–∑ backup –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
