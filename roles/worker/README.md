# Worker Role

## Описание
Роль `worker` присоединяет worker-ноду к существующему Kubernetes кластеру.

## Задачи
- Проверка статуса присоединения к кластеру
- Копирование команды join с локальной машины
- Присоединение к кластеру с помощью kubeadm join
- Проверка успешного присоединения
- **Автоматическое добавление метки worker роли**

## Переменные
Роль не требует дополнительных переменных - использует команду join из файла.

## Критически важные функции

### Проверка статуса
Проверяет существование `/etc/kubernetes/kubelet.conf` для определения статуса присоединения.

### Команда join
Использует команду из файла `./kubeadm-join-command`, которая содержит:
```bash
kubeadm join <master-ip>:6443 --token <token> --discovery-token-ca-cert-hash sha256:<hash>
```

### Автоматическая маркировка
Добавляет метку роли worker:
```bash
kubectl label node <hostname> node-role.kubernetes.io/worker= --overwrite
```

## Теги задач
- `worker-label`: только добавление метки роли

## Зависимости
- Роль `common`
- Роль `containerd`
- Роль `kubernetes`
- Инициализированный мастер кластер
- Файл `./kubeadm-join-command` с валидным токеном

## Проверка работы
```bash
# Проверка на мастере
kubectl get nodes

# Проверка на worker ноде
systemctl status kubelet
journalctl -u kubelet
```

## Процесс присоединения
1. Проверка готовности системы (cgroups, swap, containerd)
2. Выполнение preflight проверок kubeadm
3. Создание конфигурации kubelet
4. Запуск kubelet
5. Присоединение к кластеру
6. Добавление метки роли

## Возможные проблемы
- **Истёкший токен**: требуется сгенерировать новый на мастере
- **Проблемы с сетью**: проверить доступность мастера
- **cgroups**: убедиться в правильной настройке cgroup memory
- **swap**: должен быть полностью отключен

## Примечания
- Роль должна выполняться после полной настройки мастера
- Join токен имеет ограниченное время жизни
- После присоединения нода автоматически получает метку worker роли
- kubelet автоматически запускается и присоединяется к кластеру
